<?php

class GScoreRankingFlighting extends GTag {

    public function init() {
        parent::init();
    }

    public function run() {
        $flightings = GSubmission::forForm('Flighting')->findAll();
        $players = GSubmission::forForm('Player')->findAll(array('order' => 'flighting'));
        $scores = GSubmission::forForm('Score')->findAll();
        $flags = GSubmission::forForm('Country')->findAll();
        $data = array();
        foreach ($flightings as $flighting) {
            $flightingData = array();
            $flightingData['players'] = array();
            $flightingData['name'] = $flighting->name;
            foreach ($players as $player) {
                if ($player->flighting == $flighting->id) {
                    $playerData = array();
                    $total = 0;
                    foreach ($scores as $score) {
                        if($score->playerId == $player->id) $total += $score->score;
                    }

                    $playerData['id'] = $player->id;
                    $playerData['grossScore'] = $total;
                    $playerData['nettScore'] = $total - $player->handicap;
                    $playerData['name'] = $player->name;
                    if (isset($flags[$player->country]))
                        $playerData['flag'] = $flags[$player->country]->flag;
                    $flightingData['players'][$player->id] = $playerData;
                }
            }
            if(!empty($flightingData['players'])) $data[$flighting->id] = $flightingData;
        }

        $dataProvider = new CArrayDataProvider($data,
                    array('sort' => array(
                                'attributes' => array(
                                    'players' => array(
                                        'asc' => ''
                                    )
                                ),
                            ), 'pagination' => array(
                                'pageSize' => 999,
                        )));

        foreach ($dataProvider->getData() as $id => $flighting) {
            $pos = 0;
            usort($flighting['players'], function($a, $b) {
                        return $a['nettScore'] > $b['nettScore'];
                    });
            echo "<h2>Flight " . $flighting['name'] . "</h2>";
        echo "<table class='table'>";
        echo"<tr>";
        echo "<th class='th1'>POS</th>";        
        echo "<th class='th2'>Players</th>";
        echo "<th class='th3'>Gross total</th>";
        echo "<th class='th4'>Nett total</th>";
        echo"</tr>";
            foreach ($flighting['players'] as $id => $player) {
                echo "<tr>";
                echo "<td>" . ++$pos . "</td>"; 
                echo "<td>";
                if (isset($player['flag'])) {
                    echo CHtml::image($player['flag']);
                }
                echo $player['name'];
                echo "</td>";
                echo CHtml::tag('td', array(), $player['grossScore']);
                echo CHtml::tag('td', array(), $player['nettScore']);
            
                echo "</tr>";
            }
            echo "</tr>";
            echo "</table>";
        }
        parent::run();
    }

}

?>
